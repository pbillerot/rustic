{%- extends "tpl_base.html" -%}
{% import "tpl_table_elements.html" as macros %}

{%- block title -%}<div class="header item">{{ view.title }}</div>{%- endblock -%}

{%- block menu -%}{% include "tpl_menu.html" %}{%- endblock -%}

{%- block boutons -%}
{%- endblock -%}

{%- block actions -%}
{%- if application.tables[tableid].views[viewid].actions or application.tables[tableid].views[viewid].form_add -%}
{%- if not view.filters -%}
<div class="ui icon item crud-search-div">
  <!-- Recherche -->
  <i class="search link icon crud-search-active" title="Rechercher..."></i>
  <div style="display: none; white-space: nowrap;" class="crud-search">
    <div class="ui icon input">
      <input class="crud-search-input-1" type="hidden" value="">
      <input type="text" class="crud-search-input" data-url="/search/{{appid}}/{{tableid}}/{{viewid}}"
        value="{{search}}" placeholder="Recherche...">
      <i class="circular search link icon crud-search-go" title="Rechercher"></i>
    </div>
    <i class="close link icon crud-search-close" title="Fermer la recherche"></i>
  </div>
</div>
{%- endif -%}
<div class="ui dropdown item">
  <i class="ellipsis vertical icon"></i>
  <div class="menu">
    {%- if application.tables[tableid].views[viewid].form_add -%}
    <a class="ui icon item crud-jquery-url" data-url="/add/{{appid}}/{{tableid}}/{{viewid}}/{{view.form_add}}">
      <i class="plus blue icon"></i>Ajouter un élément...
    </a>
    {%- endif -%}
    {%- for action in application.tables[tableid].views[viewid].actions -%}
    <a class="item crud-jquery-action" data-confirm="{{action.with_confirm}}"
      data-url="/actionv/{{appid}}/{{tableid}}/{{viewid}}/{{loop.index}}">{{action.label}}</a>
    {%- endfor -%}
  </div>
</div>
{%- endif -%}
{%- endblock -%}

{%- block content -%}
<div class="ui container" {%- if application.in_footer -%} style="margin-bottom: 6em;height: 100%" {%- endif -%}>
  {% include "tpl_flash.html" %}
  <div class="crud-mobile-show ui label">
    {{view.title}}&nbsp;
    {%- if trs | length == 0 -%}
    (aucun élément)
    {%- elif trs | length == 1 -%}
    (1 élément)
    {%- else -%}
    ({{trs|length}} éléments)
    {%- endif -%}
  </div>
  {%- if view.form_add -%}
  <button class="right floated circular ui large plus blue icon button crud-jquery-url"
    data-url="/add/{{appid}}/{{tableid}}/{{viewid}}/{{view.form_add}}" {%- if application.in_footer -%}
    style="z-index: 1000; position: fixed; bottom: 5em; right: 2em; padding: 1em;" {%- else -%}
    style="z-index: 1000; position: fixed; bottom: 2em; right: 2em; padding: 1em;" {%- endif -%}
    title="Ajouter un élément...">
    <i class="icon plus"></i>
  </button>
  {%- endif -%}
  <!-- FILTRES DE LA VUE -->
  {%- if view.filters -%}
  <form class="ui form" id="formFilter" method="POST" action="/filter/{{appid}}/{{tableid}}/{{viewid}}">
    <input id="resetfilter" name="resetfilter" type="hidden">
    <div class="fields">
      {%- for vel in filters -%}
      <div class="bee-width-s field">
        {%- if vel.type_element == "tag" or vel.type_element == "list" or vel.type_element == "radio" -%}
        <select name="{{vel.elid}}" id="{{vel.elid}}" class="ui fluid search dropdown">
          <option value="">{{vel.label_short}}</option>
          {%- for item in vel.items -%}
          <option value="{{item.key}}" {% if item.key==vel.value %} selected{% endif %}>{{item.label}}</option>
          {%- endfor -%}
        </select>
        {%- else -%}
        <input type="text" name="{{vel.elid}}" id="{{vel.elid}}" placeholder="{{vel.label_short}}" value="{{vel.value}}">
        {%- endif -%}
      </div>
      {%- endfor -%}
      <div class="field">
        <button class="ui icon primary button" title="Sélectionner">
          <i class="search icon crud-filter-go"></i>
        </button>
      </div>
      <div class="field">
        <button class="ui icon primary button" title="Annuler la sélection">
          <i class="close icon crud-filter-clear"></i>
      </div>
      </button>
    </div><!-- end fields -->
  </form>
  {%- endif -%}
  <!-- TABLE -->
  <table
    class="ui unstackable collapsing sortable {% if view.form_view or view.form_edit %} selectable {% endif %} celled table"
    data-role="table" data-mode="columntoggle" data-appid="{{appid}}" data-tableid="{{tableid}}" data-viewid="{{viewid}}">
    <thead>
      <tr class="crud-unsort">
        {%- if view.with_line_number -%}<th>&nbsp;</th>{%- endif -%}
        {%- for el in view.velements -%}
        {%- if not el.hide -%}
        <th id="col_{{el.elid}}"
          class="ui {{el.col_align}} aligned{% if el.hide_on_mobile %} crud-mobile-hide{% endif %}{% if sortid ==  el.elid %} sorted {{sortdirection}}{% endif %} crud-ajax-sort"
          title="{{el.elid}}">{{el.label_short}}</th>
        {%- endif -%}
        {%- endfor -%}
      </tr>
    </thead>
    <tbody>
      {%- for tr in trs -%}
      <tr class="{%if tr.url_open%}crud-jquery-url{%endif%} {{tr.class}}" style="{{tr.style}}" data-url="{{tr.url_open}}" data-press="{{tr.url_press}}">
        {%- if view.with_line_number -%}<td class="right aligned">{{loop.index}}</td>{%- endif -%}
        {%- for vel in view.velements -%}
          {%- if not vel.hide -%}
          {{ macros::table_elements(el=tr.record[vel.elid]) }}
          {%- endif -%}
        {%- endfor -%}
      </tr>
      {%- endfor -%}
    </tbody>
    <!-- footer avec les sum -->
    {%- if view.with_sum and trs | length > 0 -%}
    <tfoot>
      <tr class="">
        {%- if view.with_line_number -%}<td>&nbsp;</td>{%- endif -%}
        {%- for vel in view.velements -%}
          {%- if not vel.hide -%}
            {%- if vel.with_sum -%}
              {%- if vel.type_element == "amount" -%}
              <td nowrap style="text-align: right;{% if sums[vel.elid].sum < 0.0 %}color: red{%else%}color: green{% endif %}">
                {{sums[vel.elid].sum | as_str | format_amount }}
              </td>
              {%- else -%}
              <td nowrap style="text-align: center;{% if sums[vel.elid].sum < 0.0 %}color: red{%else%}color: green{% endif %}">
                {{sums[vel.elid].sum}}
              </td>
              {%- endif -%}
            {%- else -%}
        <td></td>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      </tr>
    </tfoot>
    {%- endif -%}
  </table>
</div>
{% include "tpl_view_footer.html" %}
{%- endblock -%}
{%- block forms -%}
<input type="hidden" id="crud_view" value="{{appid}}-{{tableid}}-{{viewid}}">
{%- endblock -%}
